<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Bot Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='global.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-robot"></i>
                    <h1>Discord Bot Panel</h1>
                </div>
                <div class="header-stats">
                    <div class="stat-item">
                        <span class="stat-label">Accounts:</span>
                        <span class="stat-value" id="total-accounts">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Channels:</span>
                        <span class="stat-value" id="active-channels">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Status:</span>
                        <span class="stat-value status-indicator" id="system-status">
                            <i class="fas fa-circle"></i> Loading
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Navigation Tabs -->
            <div class="tab-navigation">
                <button class="tab-btn active" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="tab-btn" data-tab="accounts">
                    <i class="fas fa-users"></i> Accounts
                </button>
                <button class="tab-btn" data-tab="logs">
                    <i class="fas fa-list-alt"></i> Logs
                </button>
                <button class="tab-btn" data-tab="config">
                    <i class="fas fa-cog"></i> Config
                </button>
                <button class="tab-btn" data-tab="messages">
                    <i class="fas fa-comments"></i> Messages
                </button>
            </div>

            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard">
                <div class="dashboard-grid">
                    <!-- Quick Stats -->
                    <div class="card stats-card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-line"></i> Quick Stats</h3>
                        </div>
                        <div class="card-content">
                            <div class="stats-grid">
                                <div class="stat-box">
                                    <div class="stat-number" id="stat-total-accounts">0</div>
                                    <div class="stat-label">Total Accounts</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-number" id="stat-active-channels">0</div>
                                    <div class="stat-label">Active Channels</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-number" id="stat-total-logs">0</div>
                                    <div class="stat-label">Total Logs</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-number" id="stat-uptime">--:--</div>
                                    <div class="stat-label">Uptime</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Controls -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-power-off"></i> System Controls</h3>
                        </div>
                        <div class="card-content">
                            <div class="control-buttons">
                                <button class="btn btn-success" onclick="refreshStatus()">
                                    <i class="fas fa-sync"></i> Refresh Status
                                </button>
                                <button class="btn btn-warning" onclick="restartBot()">
                                    <i class="fas fa-redo"></i> Restart Bot
                                </button>
                                <button class="btn btn-info" onclick="clearLogs()">
                                    <i class="fas fa-trash"></i> Clear Logs
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Logs Preview -->
                    <div class="card recent-logs">
                        <div class="card-header">
                            <h3><i class="fas fa-clock"></i> Recent Activity</h3>
                        </div>
                        <div class="card-content">
                            <div class="log-container" id="recent-logs-container">
                                <div class="log-entry info">
                                    <span class="log-time">Loading...</span>
                                    <span class="log-message">Initializing system...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounts Tab -->
            <div class="tab-content" id="accounts">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-users"></i> Discord Accounts</h3>
                    </div>
                    <div class="card-content">
                        <div class="accounts-grid" id="accounts-grid">
                            <div class="account-card loading">
                                <div class="account-info">
                                    <div class="account-name">Loading accounts...</div>
                                    <div class="account-status">Please wait</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div class="tab-content" id="logs">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-list-alt"></i> System Logs</h3>
                        <div class="log-controls">
                            <select id="log-level-filter">
                                <option value="all">All Levels</option>
                                <option value="INFO">Info</option>
                                <option value="SUCCESS">Success</option>
                                <option value="WARNING">Warning</option>
                                <option value="ERROR">Error</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="refreshLogs()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="logs-container" id="logs-container">
                            <div class="log-entry info">
                                <span class="log-time">Loading...</span>
                                <span class="log-title">System</span>
                                <span class="log-message">Loading logs...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config Tab -->
            <div class="tab-content" id="config">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-cog"></i> Bot Configuration</h3>
                        <button class="btn btn-success" onclick="saveConfig()">
                            <i class="fas fa-save"></i> Save Config
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="config-editor">
                            <textarea id="config-editor" placeholder="Loading configuration..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Tab -->
            <div class="tab-content" id="messages">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-comments"></i> Local Messages</h3>
                        <div class="message-controls">
                            <button class="btn btn-primary" onclick="addMessage()">
                                <i class="fas fa-plus"></i> Add Message
                            </button>
                            <button class="btn btn-success" onclick="saveMessages()">
                                <i class="fas fa-save"></i> Save Messages
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="messages-editor" id="messages-editor">
                            <div class="message-item">
                                <input type="text" placeholder="Loading messages..." readonly>
                                <button class="btn-remove" onclick="removeMessage(this)" disabled>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading...</p>
        </div>
    </div>

    <!-- Notification System -->
    <div class="notification-container" id="notification-container"></div>

    <script>
        // Global variables
        let socket = null;
        let currentTab = 'dashboard';
        let systemStartTime = Date.now();
        let statusData = {};

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupTabNavigation();
            setupWebSocket();
            loadInitialData();
            startUptimeCounter();
        });

        // Initialize application
        function initializeApp() {
            hideLoading();
            showNotification('System initializing...', 'info');
        }

        // Setup tab navigation
        function setupTabNavigation() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    // Remove active class from all tabs and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active');
                    document.getElementById(tabName).classList.add('active');
                    
                    currentTab = tabName;
                    
                    // Load tab-specific data
                    loadTabData(tabName);
                });
            });
        }

        // Setup WebSocket connection
        function setupWebSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
                showNotification('Connected to bot panel', 'success');
                updateSystemStatus('online');
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                showNotification('Disconnected from server', 'error');
                updateSystemStatus('offline');
            });
            
            socket.on('new_log', function(logEntry) {
                addLogEntry(logEntry);
                updateRecentLogs(logEntry);
            });
        }

        // Load initial data
        function loadInitialData() {
            refreshStatus();
            loadTabData(currentTab);
        }

        // Load tab-specific data
        function loadTabData(tabName) {
            switch(tabName) {
                case 'dashboard':
                    refreshStatus();
                    loadRecentLogs();
                    break;
                case 'accounts':
                    loadAccounts();
                    break;
                case 'logs':
                    loadLogs();
                    break;
                case 'config':
                    loadConfig();
                    break;
                case 'messages':
                    loadMessages();
                    break;
            }
        }

        // Status functions
        function refreshStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    statusData = data;
                    updateDashboardStats(data);
                    updateHeaderStats(data);
                    updateSystemStatus('online');
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    showNotification('Failed to fetch status', 'error');
                    updateSystemStatus('error');
                });
        }

        function updateDashboardStats(data) {
            document.getElementById('stat-total-accounts').textContent = data.total_accounts || 0;
            document.getElementById('stat-active-channels').textContent = data.active_channels || 0;
            document.getElementById('stat-total-logs').textContent = data.total_logs || 0;
        }

        function updateHeaderStats(data) {
            document.getElementById('total-accounts').textContent = data.total_accounts || 0;
            document.getElementById('active-channels').textContent = data.active_channels || 0;
        }

        function updateSystemStatus(status) {
            const statusElement = document.getElementById('system-status');
            const icon = statusElement.querySelector('i');
            
            statusElement.className = 'stat-value status-indicator';
            
            switch(status) {
                case 'online':
                    statusElement.classList.add('online');
                    statusElement.innerHTML = '<i class="fas fa-circle"></i> Online';
                    break;
                case 'offline':
                    statusElement.classList.add('offline');
                    statusElement.innerHTML = '<i class="fas fa-circle"></i> Offline';
                    break;
                case 'error':
                    statusElement.classList.add('error');
                    statusElement.innerHTML = '<i class="fas fa-circle"></i> Error';
                    break;
                default:
                    statusElement.innerHTML = '<i class="fas fa-circle"></i> Unknown';
            }
        }

        // Account functions
        function loadAccounts() {
            if (!statusData.accounts) {
                refreshStatus();
                return;
            }

            const accountsGrid = document.getElementById('accounts-grid');
            accountsGrid.innerHTML = '';

            if (Object.keys(statusData.accounts).length === 0) {
                accountsGrid.innerHTML = '<div class="no-data">No accounts configured</div>';
                return;
            }

            Object.values(statusData.accounts).forEach(account => {
                const accountCard = createAccountCard(account);
                accountsGrid.appendChild(accountCard);
            });
        }

        function createAccountCard(account) {
            const card = document.createElement('div');
            card.className = `account-card ${account.status}`;
            
            card.innerHTML = `
                <div class="account-info">
                    <div class="account-name">${account.username}</div>
                    <div class="account-id">ID: ${account.user_id}</div>
                    <div class="account-token">Token: ${account.token_preview}</div>
                </div>
                <div class="account-status">
                    <span class="status-indicator ${account.status}">
                        <i class="fas fa-circle"></i> ${account.status}
                    </span>
                    <div class="last-activity">
                        ${account.last_activity ? `Last: ${account.last_activity}` : 'No activity'}
                    </div>
                </div>
            `;
            
            return card;
        }

        // Log functions
        function loadLogs() {
            fetch('/api/logs?limit=100')
                .then(response => response.json())
                .then(logs => {
                    displayLogs(logs);
                })
                .catch(error => {
                    console.error('Error loading logs:', error);
                    showNotification('Failed to load logs', 'error');
                });
        }

        function loadRecentLogs() {
            fetch('/api/logs?limit=5')
                .then(response => response.json())
                .then(logs => {
                    displayRecentLogs(logs);
                })
                .catch(error => {
                    console.error('Error loading recent logs:', error);
                });
        }

        function displayLogs(logs) {
            const container = document.getElementById('logs-container');
            container.innerHTML = '';

            if (logs.length === 0) {
                container.innerHTML = '<div class="no-data">No logs available</div>';
                return;
            }

            logs.forEach(log => {
                const logElement = createLogElement(log);
                container.appendChild(logElement);
            });

            container.scrollTop = container.scrollHeight;
        }

        function displayRecentLogs(logs) {
            const container = document.getElementById('recent-logs-container');
            container.innerHTML = '';

            if (logs.length === 0) {
                container.innerHTML = '<div class="no-data">No recent activity</div>';
                return;
            }

            logs.slice(-5).forEach(log => {
                const logElement = createSimpleLogElement(log);
                container.appendChild(logElement);
            });
        }

        function createLogElement(log) {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${log.level.toLowerCase()}`;
            
            logEntry.innerHTML = `
                <span class="log-time">${log.timestamp}</span>
                <span class="log-title">${log.title}</span>
                <span class="log-message">${log.message}</span>
            `;
            
            return logEntry;
        }

        function createSimpleLogElement(log) {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${log.level.toLowerCase()}`;
            
            logEntry.innerHTML = `
                <span class="log-time">${log.timestamp.split(' ')[1]}</span>
                <span class="log-message">${log.title}: ${log.message}</span>
            `;
            
            return logEntry;
        }

        function addLogEntry(logEntry) {
            if (currentTab === 'logs') {
                const container = document.getElementById('logs-container');
                const logElement = createLogElement(logEntry);
                container.appendChild(logElement);
                container.scrollTop = container.scrollHeight;

                // Keep only last 100 logs visible
                const logs = container.querySelectorAll('.log-entry');
                if (logs.length > 100) {
                    logs[0].remove();
                }
            }
        }

        function updateRecentLogs(logEntry) {
            const container = document.getElementById('recent-logs-container');
            const logElement = createSimpleLogElement(logEntry);
            container.appendChild(logElement);

            // Keep only last 5 logs
            const logs = container.querySelectorAll('.log-entry');
            if (logs.length > 5) {
                logs[0].remove();
            }
        }

        function refreshLogs() {
            loadLogs();
            showNotification('Logs refreshed', 'success');
        }

        // Config functions
        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    const editor = document.getElementById('config-editor');
                    editor.value = JSON.stringify(config, null, 2);
                })
                .catch(error => {
                    console.error('Error loading config:', error);
                    showNotification('Failed to load config', 'error');
                });
        }

        function saveConfig() {
            const editor = document.getElementById('config-editor');
            
            try {
                const config = JSON.parse(editor.value);
                
                showLoading();
                fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                })
                .then(response => response.json())
                .then(result => {
                    hideLoading();
                    if (result.success) {
                        showNotification('Configuration saved successfully', 'success');
                    } else {
                        showNotification('Failed to save configuration: ' + result.error, 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error saving config:', error);
                    showNotification('Failed to save configuration', 'error');
                });
            } catch (error) {
                showNotification('Invalid JSON format', 'error');
            }
        }

        // Messages functions
        function loadMessages() {
            fetch('/api/messages')
                .then(response => response.json())
                .then(data => {
                    displayMessages(data.messages || []);
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    showNotification('Failed to load messages', 'error');
                });
        }

        function displayMessages(messages) {
            const container = document.getElementById('messages-editor');
            container.innerHTML = '';

            if (messages.length === 0) {
                addMessage();
                return;
            }

            messages.forEach(message => {
                const messageElement = createMessageElement(message);
                container.appendChild(messageElement);
            });
        }

        function createMessageElement(message = '') {
            const messageItem = document.createElement('div');
            messageItem.className = 'message-item';
            
            messageItem.innerHTML = `
                <input type="text" value="${message}" placeholder="Enter message...">
                <button class="btn-remove" onclick="removeMessage(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            return messageItem;
        }

        function addMessage() {
            const container = document.getElementById('messages-editor');
            const messageElement = createMessageElement();
            container.appendChild(messageElement);
        }

        function removeMessage(button) {
            const messageItem = button.parentElement;
            messageItem.remove();
        }

        function saveMessages() {
            const container = document.getElementById('messages-editor');
            const inputs = container.querySelectorAll('input[type="text"]');
            const messages = Array.from(inputs)
                .map(input => input.value.trim())
                .filter(message => message.length > 0);

            if (messages.length === 0) {
                showNotification('Please add at least one message', 'warning');
                return;
            }

            showLoading();
            fetch('/api/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ messages })
            })
            .then(response => response.json())
            .then(result => {
                hideLoading();
                if (result.success) {
                    showNotification('Messages saved successfully', 'success');
                } else {
                    showNotification('Failed to save messages: ' + result.error, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error saving messages:', error);
                showNotification('Failed to save messages', 'error');
            });
        }

        // System control functions
        function restartBot() {
            if (!confirm('Are you sure you want to restart the bot?')) {
                return;
            }

            showLoading();
            fetch('/api/restart')
                .then(response => response.json())
                .then(result => {
                    hideLoading();
                    if (result.success) {
                        showNotification('Bot restarted successfully', 'success');
                        setTimeout(refreshStatus, 2000);
                    } else {
                        showNotification('Failed to restart bot: ' + result.error, 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error restarting bot:', error);
                    showNotification('Failed to restart bot', 'error');
                });
        }

        function clearLogs() {
            if (!confirm('Are you sure you want to clear all logs?')) {
                return;
            }

            const container = document.getElementById('logs-container');
            container.innerHTML = '<div class="no-data">Logs cleared</div>';
            
            const recentContainer = document.getElementById('recent-logs-container');
            recentContainer.innerHTML = '<div class="no-data">No recent activity</div>';
            
            showNotification('Logs cleared', 'info');
        }

        // Utility functions
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="closeNotification(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function getNotificationIcon(type) {
            const icons = {
                'success': 'check-circle',
                'error': 'exclamation-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        function closeNotification(button) {
            button.parentElement.remove();
        }

        function startUptimeCounter() {
            setInterval(() => {
                const uptimeMs = Date.now() - systemStartTime;
                const uptimeStr = formatUptime(uptimeMs);
                document.getElementById('stat-uptime').textContent = uptimeStr;
            }, 1000);
        }

        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // Auto-refresh status every 30 seconds
        setInterval(refreshStatus, 30000);
    </script>
</body>
</html>